name: aya-is-development

# ============================================================================
# Docker Compose for AYA.is Development
# ============================================================================
# Usage:
#   docker compose up                    # Start all services
#   docker compose up webclient          # Start webclient only
#   docker compose up services postgres  # Start backend only
#   docker compose watch                 # Start with hot reload (Watch mode)
#
# UIs:
#   Webclient:    http://localhost:3000
#   Services API: http://localhost:8080
#   PostgreSQL:   localhost:5432
# ============================================================================

services:
  webclient:
    tty: true
    stdin_open: true
    restart: unless-stopped
    build:
      context: .
      dockerfile: apps/webclient/Dockerfile
      target: development
    develop:
      watch:
        - action: sync
          path: ./apps/webclient/src
          target: /monorepo/apps/webclient/src
        - action: rebuild
          path: ./apps/webclient/package.json
        - action: rebuild
          path: ./apps/webclient/deno.json
    environment:
      # Vite client-side variables (bundled at build time)
      VITE_BACKEND_URI: http://localhost:8080
      VITE_HOST: http://localhost:3000
      # Server-side runtime variable (for SSR/API routes)
      BACKEND_URI: http://services:8080
    networks:
      - aya-is-network
    ports:
      - 3000:3000

  services:
    tty: true
    stdin_open: true
    restart: unless-stopped
    build:
      context: .
      dockerfile: apps/services/Dockerfile
      target: development-runner
    develop:
      watch:
        - action: sync+restart
          path: ./apps/services
          target: /srv/monorepo/apps/services
          ignore:
            - "**/*.md"
            - "**/tmp/"
    environment:
      ENV: development
      PORT: 8080
      SITE_URI: http://localhost:8080
      LOG__LEVEL: INFO
      LOG__PRETTY: false
      # JWT secret for development (generate a secure one for production)
      AUTH__JWT_SECRET: dev-secret-change-in-production
      # Database connection with both protocol and DSN
      CONN__targets__default__protocol: postgres
      CONN__targets__default__dsn: postgres://postgres:s3cr3t@postgres:5432/postgres?sslmode=disable
    networks:
      - aya-is-network
    ports:
      - 8080:8080
    depends_on:
      postgres:
        condition: service_healthy

  postgres:
    image: postgres:16-bookworm
    restart: unless-stopped
    environment:
      POSTGRES_PASSWORD: s3cr3t
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d postgres"]
      interval: 5s
      timeout: 5s
      retries: 10
    volumes:
      - postgres-data:/var/lib/postgresql/data
      # - ./resources/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - aya-is-network
    ports:
      - 5432:5432

volumes:
  postgres-data:

networks:
  aya-is-network:
    driver: bridge
