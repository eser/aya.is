// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.29.0
// source: profile_envelopes.sql

package storage

import (
	"context"
	"database/sql"
	"time"

	"github.com/sqlc-dev/pqtype"
)

const countPendingProfileEnvelopes = `-- name: CountPendingProfileEnvelopes :one
SELECT COUNT(*)::INT as count
FROM "profile_envelope"
WHERE target_profile_id = $1
  AND status = 'pending'
  AND deleted_at IS NULL
`

type CountPendingProfileEnvelopesParams struct {
	TargetProfileID string `db:"target_profile_id" json:"target_profile_id"`
}

// CountPendingProfileEnvelopes
//
//	SELECT COUNT(*)::INT as count
//	FROM "profile_envelope"
//	WHERE target_profile_id = $1
//	  AND status = 'pending'
//	  AND deleted_at IS NULL
func (q *Queries) CountPendingProfileEnvelopes(ctx context.Context, arg CountPendingProfileEnvelopesParams) (int32, error) {
	row := q.db.QueryRowContext(ctx, countPendingProfileEnvelopes, arg.TargetProfileID)
	var count int32
	err := row.Scan(&count)
	return count, err
}

const createProfileEnvelope = `-- name: CreateProfileEnvelope :exec
INSERT INTO "profile_envelope" (
  id, target_profile_id, sender_profile_id, sender_user_id,
  kind, status, title, description, properties, created_at
) VALUES (
  $1,
  $2,
  $3,
  $4,
  $5,
  'pending',
  $6,
  $7,
  $8,
  NOW()
)
`

type CreateProfileEnvelopeParams struct {
	ID              string                `db:"id" json:"id"`
	TargetProfileID string                `db:"target_profile_id" json:"target_profile_id"`
	SenderProfileID sql.NullString        `db:"sender_profile_id" json:"sender_profile_id"`
	SenderUserID    sql.NullString        `db:"sender_user_id" json:"sender_user_id"`
	Kind            string                `db:"kind" json:"kind"`
	Title           string                `db:"title" json:"title"`
	Description     sql.NullString        `db:"description" json:"description"`
	Properties      pqtype.NullRawMessage `db:"properties" json:"properties"`
}

// CreateProfileEnvelope
//
//	INSERT INTO "profile_envelope" (
//	  id, target_profile_id, sender_profile_id, sender_user_id,
//	  kind, status, title, description, properties, created_at
//	) VALUES (
//	  $1,
//	  $2,
//	  $3,
//	  $4,
//	  $5,
//	  'pending',
//	  $6,
//	  $7,
//	  $8,
//	  NOW()
//	)
func (q *Queries) CreateProfileEnvelope(ctx context.Context, arg CreateProfileEnvelopeParams) error {
	_, err := q.db.ExecContext(ctx, createProfileEnvelope,
		arg.ID,
		arg.TargetProfileID,
		arg.SenderProfileID,
		arg.SenderUserID,
		arg.Kind,
		arg.Title,
		arg.Description,
		arg.Properties,
	)
	return err
}

const getProfileEnvelopeByID = `-- name: GetProfileEnvelopeByID :one
SELECT id, target_profile_id, sender_profile_id, sender_user_id, kind, status, title, description, properties, accepted_at, rejected_at, revoked_at, redeemed_at, created_at, updated_at, deleted_at
FROM "profile_envelope"
WHERE id = $1
  AND deleted_at IS NULL
`

type GetProfileEnvelopeByIDParams struct {
	ID string `db:"id" json:"id"`
}

// GetProfileEnvelopeByID
//
//	SELECT id, target_profile_id, sender_profile_id, sender_user_id, kind, status, title, description, properties, accepted_at, rejected_at, revoked_at, redeemed_at, created_at, updated_at, deleted_at
//	FROM "profile_envelope"
//	WHERE id = $1
//	  AND deleted_at IS NULL
func (q *Queries) GetProfileEnvelopeByID(ctx context.Context, arg GetProfileEnvelopeByIDParams) (*ProfileEnvelope, error) {
	row := q.db.QueryRowContext(ctx, getProfileEnvelopeByID, arg.ID)
	var i ProfileEnvelope
	err := row.Scan(
		&i.ID,
		&i.TargetProfileID,
		&i.SenderProfileID,
		&i.SenderUserID,
		&i.Kind,
		&i.Status,
		&i.Title,
		&i.Description,
		&i.Properties,
		&i.AcceptedAt,
		&i.RejectedAt,
		&i.RevokedAt,
		&i.RedeemedAt,
		&i.CreatedAt,
		&i.UpdatedAt,
		&i.DeletedAt,
	)
	return &i, err
}

const listAcceptedInvitations = `-- name: ListAcceptedInvitations :many
SELECT
  pe.id, pe.target_profile_id, pe.sender_profile_id, pe.sender_user_id, pe.kind, pe.status, pe.title, pe.description, pe.properties, pe.accepted_at, pe.rejected_at, pe.revoked_at, pe.redeemed_at, pe.created_at, pe.updated_at, pe.deleted_at,
  sp.slug as sender_profile_slug,
  COALESCE(spt.title, '') as sender_profile_title,
  sp.profile_picture_uri as sender_profile_picture_uri,
  sp.kind as sender_profile_kind
FROM "profile_envelope" pe
  LEFT JOIN "profile" sp ON sp.id = pe.sender_profile_id AND sp.deleted_at IS NULL
  LEFT JOIN "profile_tx" spt ON spt.profile_id = sp.id AND spt.locale_code = sp.default_locale
WHERE pe.target_profile_id = $1
  AND pe.kind = 'invitation'
  AND pe.status = 'accepted'
  AND pe.deleted_at IS NULL
  AND ($2::TEXT IS NULL
       OR pe.properties->>'invitation_kind' = $2)
ORDER BY pe.created_at DESC
`

type ListAcceptedInvitationsParams struct {
	TargetProfileID string         `db:"target_profile_id" json:"target_profile_id"`
	InvitationKind  sql.NullString `db:"invitation_kind" json:"invitation_kind"`
}

type ListAcceptedInvitationsRow struct {
	ID                      string                `db:"id" json:"id"`
	TargetProfileID         string                `db:"target_profile_id" json:"target_profile_id"`
	SenderProfileID         sql.NullString        `db:"sender_profile_id" json:"sender_profile_id"`
	SenderUserID            sql.NullString        `db:"sender_user_id" json:"sender_user_id"`
	Kind                    string                `db:"kind" json:"kind"`
	Status                  string                `db:"status" json:"status"`
	Title                   string                `db:"title" json:"title"`
	Description             sql.NullString        `db:"description" json:"description"`
	Properties              pqtype.NullRawMessage `db:"properties" json:"properties"`
	AcceptedAt              sql.NullTime          `db:"accepted_at" json:"accepted_at"`
	RejectedAt              sql.NullTime          `db:"rejected_at" json:"rejected_at"`
	RevokedAt               sql.NullTime          `db:"revoked_at" json:"revoked_at"`
	RedeemedAt              sql.NullTime          `db:"redeemed_at" json:"redeemed_at"`
	CreatedAt               time.Time             `db:"created_at" json:"created_at"`
	UpdatedAt               sql.NullTime          `db:"updated_at" json:"updated_at"`
	DeletedAt               sql.NullTime          `db:"deleted_at" json:"deleted_at"`
	SenderProfileSlug       sql.NullString        `db:"sender_profile_slug" json:"sender_profile_slug"`
	SenderProfileTitle      string                `db:"sender_profile_title" json:"sender_profile_title"`
	SenderProfilePictureURI sql.NullString        `db:"sender_profile_picture_uri" json:"sender_profile_picture_uri"`
	SenderProfileKind       sql.NullString        `db:"sender_profile_kind" json:"sender_profile_kind"`
}

// ListAcceptedInvitations
//
//	SELECT
//	  pe.id, pe.target_profile_id, pe.sender_profile_id, pe.sender_user_id, pe.kind, pe.status, pe.title, pe.description, pe.properties, pe.accepted_at, pe.rejected_at, pe.revoked_at, pe.redeemed_at, pe.created_at, pe.updated_at, pe.deleted_at,
//	  sp.slug as sender_profile_slug,
//	  COALESCE(spt.title, '') as sender_profile_title,
//	  sp.profile_picture_uri as sender_profile_picture_uri,
//	  sp.kind as sender_profile_kind
//	FROM "profile_envelope" pe
//	  LEFT JOIN "profile" sp ON sp.id = pe.sender_profile_id AND sp.deleted_at IS NULL
//	  LEFT JOIN "profile_tx" spt ON spt.profile_id = sp.id AND spt.locale_code = sp.default_locale
//	WHERE pe.target_profile_id = $1
//	  AND pe.kind = 'invitation'
//	  AND pe.status = 'accepted'
//	  AND pe.deleted_at IS NULL
//	  AND ($2::TEXT IS NULL
//	       OR pe.properties->>'invitation_kind' = $2)
//	ORDER BY pe.created_at DESC
func (q *Queries) ListAcceptedInvitations(ctx context.Context, arg ListAcceptedInvitationsParams) ([]*ListAcceptedInvitationsRow, error) {
	rows, err := q.db.QueryContext(ctx, listAcceptedInvitations, arg.TargetProfileID, arg.InvitationKind)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	items := []*ListAcceptedInvitationsRow{}
	for rows.Next() {
		var i ListAcceptedInvitationsRow
		if err := rows.Scan(
			&i.ID,
			&i.TargetProfileID,
			&i.SenderProfileID,
			&i.SenderUserID,
			&i.Kind,
			&i.Status,
			&i.Title,
			&i.Description,
			&i.Properties,
			&i.AcceptedAt,
			&i.RejectedAt,
			&i.RevokedAt,
			&i.RedeemedAt,
			&i.CreatedAt,
			&i.UpdatedAt,
			&i.DeletedAt,
			&i.SenderProfileSlug,
			&i.SenderProfileTitle,
			&i.SenderProfilePictureURI,
			&i.SenderProfileKind,
		); err != nil {
			return nil, err
		}
		items = append(items, &i)
	}
	if err := rows.Close(); err != nil {
		return nil, err
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const listProfileEnvelopesByTargetProfileID = `-- name: ListProfileEnvelopesByTargetProfileID :many
SELECT
  pe.id, pe.target_profile_id, pe.sender_profile_id, pe.sender_user_id, pe.kind, pe.status, pe.title, pe.description, pe.properties, pe.accepted_at, pe.rejected_at, pe.revoked_at, pe.redeemed_at, pe.created_at, pe.updated_at, pe.deleted_at,
  sp.slug as sender_profile_slug,
  COALESCE(spt.title, '') as sender_profile_title,
  sp.profile_picture_uri as sender_profile_picture_uri,
  sp.kind as sender_profile_kind
FROM "profile_envelope" pe
  LEFT JOIN "profile" sp ON sp.id = pe.sender_profile_id AND sp.deleted_at IS NULL
  LEFT JOIN "profile_tx" spt ON spt.profile_id = sp.id AND spt.locale_code = sp.default_locale
WHERE pe.target_profile_id = $1
  AND pe.deleted_at IS NULL
  AND ($2::TEXT IS NULL OR pe.status = $2)
ORDER BY pe.created_at DESC
LIMIT $3
`

type ListProfileEnvelopesByTargetProfileIDParams struct {
	TargetProfileID string         `db:"target_profile_id" json:"target_profile_id"`
	StatusFilter    sql.NullString `db:"status_filter" json:"status_filter"`
	LimitCount      int32          `db:"limit_count" json:"limit_count"`
}

type ListProfileEnvelopesByTargetProfileIDRow struct {
	ID                      string                `db:"id" json:"id"`
	TargetProfileID         string                `db:"target_profile_id" json:"target_profile_id"`
	SenderProfileID         sql.NullString        `db:"sender_profile_id" json:"sender_profile_id"`
	SenderUserID            sql.NullString        `db:"sender_user_id" json:"sender_user_id"`
	Kind                    string                `db:"kind" json:"kind"`
	Status                  string                `db:"status" json:"status"`
	Title                   string                `db:"title" json:"title"`
	Description             sql.NullString        `db:"description" json:"description"`
	Properties              pqtype.NullRawMessage `db:"properties" json:"properties"`
	AcceptedAt              sql.NullTime          `db:"accepted_at" json:"accepted_at"`
	RejectedAt              sql.NullTime          `db:"rejected_at" json:"rejected_at"`
	RevokedAt               sql.NullTime          `db:"revoked_at" json:"revoked_at"`
	RedeemedAt              sql.NullTime          `db:"redeemed_at" json:"redeemed_at"`
	CreatedAt               time.Time             `db:"created_at" json:"created_at"`
	UpdatedAt               sql.NullTime          `db:"updated_at" json:"updated_at"`
	DeletedAt               sql.NullTime          `db:"deleted_at" json:"deleted_at"`
	SenderProfileSlug       sql.NullString        `db:"sender_profile_slug" json:"sender_profile_slug"`
	SenderProfileTitle      string                `db:"sender_profile_title" json:"sender_profile_title"`
	SenderProfilePictureURI sql.NullString        `db:"sender_profile_picture_uri" json:"sender_profile_picture_uri"`
	SenderProfileKind       sql.NullString        `db:"sender_profile_kind" json:"sender_profile_kind"`
}

// ListProfileEnvelopesByTargetProfileID
//
//	SELECT
//	  pe.id, pe.target_profile_id, pe.sender_profile_id, pe.sender_user_id, pe.kind, pe.status, pe.title, pe.description, pe.properties, pe.accepted_at, pe.rejected_at, pe.revoked_at, pe.redeemed_at, pe.created_at, pe.updated_at, pe.deleted_at,
//	  sp.slug as sender_profile_slug,
//	  COALESCE(spt.title, '') as sender_profile_title,
//	  sp.profile_picture_uri as sender_profile_picture_uri,
//	  sp.kind as sender_profile_kind
//	FROM "profile_envelope" pe
//	  LEFT JOIN "profile" sp ON sp.id = pe.sender_profile_id AND sp.deleted_at IS NULL
//	  LEFT JOIN "profile_tx" spt ON spt.profile_id = sp.id AND spt.locale_code = sp.default_locale
//	WHERE pe.target_profile_id = $1
//	  AND pe.deleted_at IS NULL
//	  AND ($2::TEXT IS NULL OR pe.status = $2)
//	ORDER BY pe.created_at DESC
//	LIMIT $3
func (q *Queries) ListProfileEnvelopesByTargetProfileID(ctx context.Context, arg ListProfileEnvelopesByTargetProfileIDParams) ([]*ListProfileEnvelopesByTargetProfileIDRow, error) {
	rows, err := q.db.QueryContext(ctx, listProfileEnvelopesByTargetProfileID, arg.TargetProfileID, arg.StatusFilter, arg.LimitCount)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	items := []*ListProfileEnvelopesByTargetProfileIDRow{}
	for rows.Next() {
		var i ListProfileEnvelopesByTargetProfileIDRow
		if err := rows.Scan(
			&i.ID,
			&i.TargetProfileID,
			&i.SenderProfileID,
			&i.SenderUserID,
			&i.Kind,
			&i.Status,
			&i.Title,
			&i.Description,
			&i.Properties,
			&i.AcceptedAt,
			&i.RejectedAt,
			&i.RevokedAt,
			&i.RedeemedAt,
			&i.CreatedAt,
			&i.UpdatedAt,
			&i.DeletedAt,
			&i.SenderProfileSlug,
			&i.SenderProfileTitle,
			&i.SenderProfilePictureURI,
			&i.SenderProfileKind,
		); err != nil {
			return nil, err
		}
		items = append(items, &i)
	}
	if err := rows.Close(); err != nil {
		return nil, err
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const updateProfileEnvelopeProperties = `-- name: UpdateProfileEnvelopeProperties :exec
UPDATE "profile_envelope"
SET properties = $1,
    updated_at = NOW()
WHERE id = $2
  AND deleted_at IS NULL
`

type UpdateProfileEnvelopePropertiesParams struct {
	Properties pqtype.NullRawMessage `db:"properties" json:"properties"`
	ID         string                `db:"id" json:"id"`
}

// UpdateProfileEnvelopeProperties
//
//	UPDATE "profile_envelope"
//	SET properties = $1,
//	    updated_at = NOW()
//	WHERE id = $2
//	  AND deleted_at IS NULL
func (q *Queries) UpdateProfileEnvelopeProperties(ctx context.Context, arg UpdateProfileEnvelopePropertiesParams) error {
	_, err := q.db.ExecContext(ctx, updateProfileEnvelopeProperties, arg.Properties, arg.ID)
	return err
}

const updateProfileEnvelopeStatusToAccepted = `-- name: UpdateProfileEnvelopeStatusToAccepted :execrows
UPDATE "profile_envelope"
SET status = 'accepted',
    accepted_at = $1,
    updated_at = $1
WHERE id = $2
  AND status = 'pending'
  AND deleted_at IS NULL
`

type UpdateProfileEnvelopeStatusToAcceptedParams struct {
	Now sql.NullTime `db:"now" json:"now"`
	ID  string       `db:"id" json:"id"`
}

// UpdateProfileEnvelopeStatusToAccepted
//
//	UPDATE "profile_envelope"
//	SET status = 'accepted',
//	    accepted_at = $1,
//	    updated_at = $1
//	WHERE id = $2
//	  AND status = 'pending'
//	  AND deleted_at IS NULL
func (q *Queries) UpdateProfileEnvelopeStatusToAccepted(ctx context.Context, arg UpdateProfileEnvelopeStatusToAcceptedParams) (int64, error) {
	result, err := q.db.ExecContext(ctx, updateProfileEnvelopeStatusToAccepted, arg.Now, arg.ID)
	if err != nil {
		return 0, err
	}
	return result.RowsAffected()
}

const updateProfileEnvelopeStatusToRedeemed = `-- name: UpdateProfileEnvelopeStatusToRedeemed :execrows
UPDATE "profile_envelope"
SET status = 'redeemed',
    redeemed_at = $1,
    updated_at = $1
WHERE id = $2
  AND status = 'accepted'
  AND deleted_at IS NULL
`

type UpdateProfileEnvelopeStatusToRedeemedParams struct {
	Now sql.NullTime `db:"now" json:"now"`
	ID  string       `db:"id" json:"id"`
}

// UpdateProfileEnvelopeStatusToRedeemed
//
//	UPDATE "profile_envelope"
//	SET status = 'redeemed',
//	    redeemed_at = $1,
//	    updated_at = $1
//	WHERE id = $2
//	  AND status = 'accepted'
//	  AND deleted_at IS NULL
func (q *Queries) UpdateProfileEnvelopeStatusToRedeemed(ctx context.Context, arg UpdateProfileEnvelopeStatusToRedeemedParams) (int64, error) {
	result, err := q.db.ExecContext(ctx, updateProfileEnvelopeStatusToRedeemed, arg.Now, arg.ID)
	if err != nil {
		return 0, err
	}
	return result.RowsAffected()
}

const updateProfileEnvelopeStatusToRejected = `-- name: UpdateProfileEnvelopeStatusToRejected :execrows
UPDATE "profile_envelope"
SET status = 'rejected',
    rejected_at = $1,
    updated_at = $1
WHERE id = $2
  AND status = 'pending'
  AND deleted_at IS NULL
`

type UpdateProfileEnvelopeStatusToRejectedParams struct {
	Now sql.NullTime `db:"now" json:"now"`
	ID  string       `db:"id" json:"id"`
}

// UpdateProfileEnvelopeStatusToRejected
//
//	UPDATE "profile_envelope"
//	SET status = 'rejected',
//	    rejected_at = $1,
//	    updated_at = $1
//	WHERE id = $2
//	  AND status = 'pending'
//	  AND deleted_at IS NULL
func (q *Queries) UpdateProfileEnvelopeStatusToRejected(ctx context.Context, arg UpdateProfileEnvelopeStatusToRejectedParams) (int64, error) {
	result, err := q.db.ExecContext(ctx, updateProfileEnvelopeStatusToRejected, arg.Now, arg.ID)
	if err != nil {
		return 0, err
	}
	return result.RowsAffected()
}

const updateProfileEnvelopeStatusToRevoked = `-- name: UpdateProfileEnvelopeStatusToRevoked :execrows
UPDATE "profile_envelope"
SET status = 'revoked',
    revoked_at = $1,
    updated_at = $1
WHERE id = $2
  AND status = 'pending'
  AND deleted_at IS NULL
`

type UpdateProfileEnvelopeStatusToRevokedParams struct {
	Now sql.NullTime `db:"now" json:"now"`
	ID  string       `db:"id" json:"id"`
}

// UpdateProfileEnvelopeStatusToRevoked
//
//	UPDATE "profile_envelope"
//	SET status = 'revoked',
//	    revoked_at = $1,
//	    updated_at = $1
//	WHERE id = $2
//	  AND status = 'pending'
//	  AND deleted_at IS NULL
func (q *Queries) UpdateProfileEnvelopeStatusToRevoked(ctx context.Context, arg UpdateProfileEnvelopeStatusToRevokedParams) (int64, error) {
	result, err := q.db.ExecContext(ctx, updateProfileEnvelopeStatusToRevoked, arg.Now, arg.ID)
	if err != nil {
		return 0, err
	}
	return result.RowsAffected()
}
