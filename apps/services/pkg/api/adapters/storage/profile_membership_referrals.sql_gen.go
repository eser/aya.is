// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.29.0
// source: profile_membership_referrals.sql

package storage

import (
	"context"
	"database/sql"
	"time"
)

const createProfileMembershipReferral = `-- name: CreateProfileMembershipReferral :one
INSERT INTO "profile_membership_referral" (
  id, profile_id, referred_profile_id, referrer_membership_id, status, created_at
) VALUES (
  $1,
  $2,
  $3,
  $4,
  'voting',
  NOW()
) RETURNING id, profile_id, referred_profile_id, referrer_membership_id, status, vote_count, created_at, updated_at, deleted_at
`

type CreateProfileMembershipReferralParams struct {
	ID                   string `db:"id" json:"id"`
	ProfileID            string `db:"profile_id" json:"profile_id"`
	ReferredProfileID    string `db:"referred_profile_id" json:"referred_profile_id"`
	ReferrerMembershipID string `db:"referrer_membership_id" json:"referrer_membership_id"`
}

// CreateProfileMembershipReferral
//
//	INSERT INTO "profile_membership_referral" (
//	  id, profile_id, referred_profile_id, referrer_membership_id, status, created_at
//	) VALUES (
//	  $1,
//	  $2,
//	  $3,
//	  $4,
//	  'voting',
//	  NOW()
//	) RETURNING id, profile_id, referred_profile_id, referrer_membership_id, status, vote_count, created_at, updated_at, deleted_at
func (q *Queries) CreateProfileMembershipReferral(ctx context.Context, arg CreateProfileMembershipReferralParams) (*ProfileMembershipReferral, error) {
	row := q.db.QueryRowContext(ctx, createProfileMembershipReferral,
		arg.ID,
		arg.ProfileID,
		arg.ReferredProfileID,
		arg.ReferrerMembershipID,
	)
	var i ProfileMembershipReferral
	err := row.Scan(
		&i.ID,
		&i.ProfileID,
		&i.ReferredProfileID,
		&i.ReferrerMembershipID,
		&i.Status,
		&i.VoteCount,
		&i.CreatedAt,
		&i.UpdatedAt,
		&i.DeletedAt,
	)
	return &i, err
}

const getProfileMembershipReferralByID = `-- name: GetProfileMembershipReferralByID :one
SELECT id, profile_id, referred_profile_id, referrer_membership_id, status, vote_count, created_at, updated_at, deleted_at FROM "profile_membership_referral"
WHERE id = $1 AND deleted_at IS NULL
`

type GetProfileMembershipReferralByIDParams struct {
	ID string `db:"id" json:"id"`
}

// GetProfileMembershipReferralByID
//
//	SELECT id, profile_id, referred_profile_id, referrer_membership_id, status, vote_count, created_at, updated_at, deleted_at FROM "profile_membership_referral"
//	WHERE id = $1 AND deleted_at IS NULL
func (q *Queries) GetProfileMembershipReferralByID(ctx context.Context, arg GetProfileMembershipReferralByIDParams) (*ProfileMembershipReferral, error) {
	row := q.db.QueryRowContext(ctx, getProfileMembershipReferralByID, arg.ID)
	var i ProfileMembershipReferral
	err := row.Scan(
		&i.ID,
		&i.ProfileID,
		&i.ReferredProfileID,
		&i.ReferrerMembershipID,
		&i.Status,
		&i.VoteCount,
		&i.CreatedAt,
		&i.UpdatedAt,
		&i.DeletedAt,
	)
	return &i, err
}

const getProfileMembershipReferralByProfileAndReferred = `-- name: GetProfileMembershipReferralByProfileAndReferred :one
SELECT id, profile_id, referred_profile_id, referrer_membership_id, status, vote_count, created_at, updated_at, deleted_at FROM "profile_membership_referral"
WHERE profile_id = $1
  AND referred_profile_id = $2
  AND deleted_at IS NULL
`

type GetProfileMembershipReferralByProfileAndReferredParams struct {
	ProfileID         string `db:"profile_id" json:"profile_id"`
	ReferredProfileID string `db:"referred_profile_id" json:"referred_profile_id"`
}

// GetProfileMembershipReferralByProfileAndReferred
//
//	SELECT id, profile_id, referred_profile_id, referrer_membership_id, status, vote_count, created_at, updated_at, deleted_at FROM "profile_membership_referral"
//	WHERE profile_id = $1
//	  AND referred_profile_id = $2
//	  AND deleted_at IS NULL
func (q *Queries) GetProfileMembershipReferralByProfileAndReferred(ctx context.Context, arg GetProfileMembershipReferralByProfileAndReferredParams) (*ProfileMembershipReferral, error) {
	row := q.db.QueryRowContext(ctx, getProfileMembershipReferralByProfileAndReferred, arg.ProfileID, arg.ReferredProfileID)
	var i ProfileMembershipReferral
	err := row.Scan(
		&i.ID,
		&i.ProfileID,
		&i.ReferredProfileID,
		&i.ReferrerMembershipID,
		&i.Status,
		&i.VoteCount,
		&i.CreatedAt,
		&i.UpdatedAt,
		&i.DeletedAt,
	)
	return &i, err
}

const getReferralVoteBreakdown = `-- name: GetReferralVoteBreakdown :many
SELECT score, COUNT(*)::BIGINT AS count
FROM "profile_membership_referral_vote"
WHERE profile_membership_referral_id = $1
GROUP BY score
ORDER BY score
`

type GetReferralVoteBreakdownParams struct {
	ReferralID string `db:"referral_id" json:"referral_id"`
}

type GetReferralVoteBreakdownRow struct {
	Score int16 `db:"score" json:"score"`
	Count int64 `db:"count" json:"count"`
}

// GetReferralVoteBreakdown
//
//	SELECT score, COUNT(*)::BIGINT AS count
//	FROM "profile_membership_referral_vote"
//	WHERE profile_membership_referral_id = $1
//	GROUP BY score
//	ORDER BY score
func (q *Queries) GetReferralVoteBreakdown(ctx context.Context, arg GetReferralVoteBreakdownParams) ([]*GetReferralVoteBreakdownRow, error) {
	rows, err := q.db.QueryContext(ctx, getReferralVoteBreakdown, arg.ReferralID)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	items := []*GetReferralVoteBreakdownRow{}
	for rows.Next() {
		var i GetReferralVoteBreakdownRow
		if err := rows.Scan(&i.Score, &i.Count); err != nil {
			return nil, err
		}
		items = append(items, &i)
	}
	if err := rows.Close(); err != nil {
		return nil, err
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const insertReferralTeam = `-- name: InsertReferralTeam :one
INSERT INTO "profile_membership_referral_team" (
  id, profile_membership_referral_id, profile_team_id, created_at
) VALUES (
  $1,
  $2,
  $3,
  NOW()
) RETURNING id, profile_membership_referral_id, profile_team_id, created_at, deleted_at
`

type InsertReferralTeamParams struct {
	ID                          string `db:"id" json:"id"`
	ProfileMembershipReferralID string `db:"profile_membership_referral_id" json:"profile_membership_referral_id"`
	ProfileTeamID               string `db:"profile_team_id" json:"profile_team_id"`
}

// InsertReferralTeam
//
//	INSERT INTO "profile_membership_referral_team" (
//	  id, profile_membership_referral_id, profile_team_id, created_at
//	) VALUES (
//	  $1,
//	  $2,
//	  $3,
//	  NOW()
//	) RETURNING id, profile_membership_referral_id, profile_team_id, created_at, deleted_at
func (q *Queries) InsertReferralTeam(ctx context.Context, arg InsertReferralTeamParams) (*ProfileMembershipReferralTeam, error) {
	row := q.db.QueryRowContext(ctx, insertReferralTeam, arg.ID, arg.ProfileMembershipReferralID, arg.ProfileTeamID)
	var i ProfileMembershipReferralTeam
	err := row.Scan(
		&i.ID,
		&i.ProfileMembershipReferralID,
		&i.ProfileTeamID,
		&i.CreatedAt,
		&i.DeletedAt,
	)
	return &i, err
}

const listProfileMembershipReferralsByProfileID = `-- name: ListProfileMembershipReferralsByProfileID :many
SELECT
  pmr.id, pmr.profile_id, pmr.referred_profile_id, pmr.referrer_membership_id, pmr.status, pmr.vote_count, pmr.created_at, pmr.updated_at, pmr.deleted_at,
  ref_p.slug AS referrer_profile_slug,
  ref_p.kind AS referrer_profile_kind,
  ref_p.profile_picture_uri AS referrer_profile_picture_uri,
  ref_pt.title AS referrer_profile_title,
  tgt_p.slug AS referred_profile_slug,
  tgt_p.kind AS referred_profile_kind,
  tgt_p.profile_picture_uri AS referred_profile_picture_uri,
  tgt_pt.title AS referred_profile_title,
  (SELECT COUNT(*) FROM "profile_membership_referral_vote" v
   WHERE v.profile_membership_referral_id = pmr.id)::BIGINT AS total_votes,
  COALESCE((SELECT AVG(v.score)::NUMERIC(3,2) FROM "profile_membership_referral_vote" v
   WHERE v.profile_membership_referral_id = pmr.id), 0)::TEXT AS average_score,
  (SELECT v.score FROM "profile_membership_referral_vote" v
   WHERE v.profile_membership_referral_id = pmr.id
     AND v.voter_membership_id = $1
  ) AS viewer_vote_score,
  (SELECT v.comment FROM "profile_membership_referral_vote" v
   WHERE v.profile_membership_referral_id = pmr.id
     AND v.voter_membership_id = $1
  ) AS viewer_vote_comment
FROM "profile_membership_referral" pmr
  INNER JOIN "profile_membership" ref_pm ON ref_pm.id = pmr.referrer_membership_id
  INNER JOIN "profile" ref_p ON ref_p.id = ref_pm.member_profile_id AND ref_p.deleted_at IS NULL
  INNER JOIN "profile_tx" ref_pt ON ref_pt.profile_id = ref_p.id
    AND ref_pt.locale_code = (
      SELECT rptf.locale_code FROM "profile_tx" rptf
      WHERE rptf.profile_id = ref_p.id
      ORDER BY CASE
        WHEN rptf.locale_code = $2 THEN 0
        WHEN rptf.locale_code = ref_p.default_locale THEN 1
        ELSE 2
      END
      LIMIT 1
    )
  INNER JOIN "profile" tgt_p ON tgt_p.id = pmr.referred_profile_id AND tgt_p.deleted_at IS NULL
  INNER JOIN "profile_tx" tgt_pt ON tgt_pt.profile_id = tgt_p.id
    AND tgt_pt.locale_code = (
      SELECT tptf.locale_code FROM "profile_tx" tptf
      WHERE tptf.profile_id = tgt_p.id
      ORDER BY CASE
        WHEN tptf.locale_code = $2 THEN 0
        WHEN tptf.locale_code = tgt_p.default_locale THEN 1
        ELSE 2
      END
      LIMIT 1
    )
WHERE pmr.profile_id = $3
  AND pmr.deleted_at IS NULL
ORDER BY pmr.created_at DESC
`

type ListProfileMembershipReferralsByProfileIDParams struct {
	ViewerMembershipID sql.NullString `db:"viewer_membership_id" json:"viewer_membership_id"`
	LocaleCode         string         `db:"locale_code" json:"locale_code"`
	ProfileID          string         `db:"profile_id" json:"profile_id"`
}

type ListProfileMembershipReferralsByProfileIDRow struct {
	ID                        string         `db:"id" json:"id"`
	ProfileID                 string         `db:"profile_id" json:"profile_id"`
	ReferredProfileID         string         `db:"referred_profile_id" json:"referred_profile_id"`
	ReferrerMembershipID      string         `db:"referrer_membership_id" json:"referrer_membership_id"`
	Status                    string         `db:"status" json:"status"`
	VoteCount                 int32          `db:"vote_count" json:"vote_count"`
	CreatedAt                 time.Time      `db:"created_at" json:"created_at"`
	UpdatedAt                 sql.NullTime   `db:"updated_at" json:"updated_at"`
	DeletedAt                 sql.NullTime   `db:"deleted_at" json:"deleted_at"`
	ReferrerProfileSlug       string         `db:"referrer_profile_slug" json:"referrer_profile_slug"`
	ReferrerProfileKind       string         `db:"referrer_profile_kind" json:"referrer_profile_kind"`
	ReferrerProfilePictureURI sql.NullString `db:"referrer_profile_picture_uri" json:"referrer_profile_picture_uri"`
	ReferrerProfileTitle      string         `db:"referrer_profile_title" json:"referrer_profile_title"`
	ReferredProfileSlug       string         `db:"referred_profile_slug" json:"referred_profile_slug"`
	ReferredProfileKind       string         `db:"referred_profile_kind" json:"referred_profile_kind"`
	ReferredProfilePictureURI sql.NullString `db:"referred_profile_picture_uri" json:"referred_profile_picture_uri"`
	ReferredProfileTitle      string         `db:"referred_profile_title" json:"referred_profile_title"`
	TotalVotes                int64          `db:"total_votes" json:"total_votes"`
	AverageScore              string         `db:"average_score" json:"average_score"`
	ViewerVoteScore           int16          `db:"viewer_vote_score" json:"viewer_vote_score"`
	ViewerVoteComment         sql.NullString `db:"viewer_vote_comment" json:"viewer_vote_comment"`
}

// ListProfileMembershipReferralsByProfileID
//
//	SELECT
//	  pmr.id, pmr.profile_id, pmr.referred_profile_id, pmr.referrer_membership_id, pmr.status, pmr.vote_count, pmr.created_at, pmr.updated_at, pmr.deleted_at,
//	  ref_p.slug AS referrer_profile_slug,
//	  ref_p.kind AS referrer_profile_kind,
//	  ref_p.profile_picture_uri AS referrer_profile_picture_uri,
//	  ref_pt.title AS referrer_profile_title,
//	  tgt_p.slug AS referred_profile_slug,
//	  tgt_p.kind AS referred_profile_kind,
//	  tgt_p.profile_picture_uri AS referred_profile_picture_uri,
//	  tgt_pt.title AS referred_profile_title,
//	  (SELECT COUNT(*) FROM "profile_membership_referral_vote" v
//	   WHERE v.profile_membership_referral_id = pmr.id)::BIGINT AS total_votes,
//	  COALESCE((SELECT AVG(v.score)::NUMERIC(3,2) FROM "profile_membership_referral_vote" v
//	   WHERE v.profile_membership_referral_id = pmr.id), 0)::TEXT AS average_score,
//	  (SELECT v.score FROM "profile_membership_referral_vote" v
//	   WHERE v.profile_membership_referral_id = pmr.id
//	     AND v.voter_membership_id = $1
//	  ) AS viewer_vote_score,
//	  (SELECT v.comment FROM "profile_membership_referral_vote" v
//	   WHERE v.profile_membership_referral_id = pmr.id
//	     AND v.voter_membership_id = $1
//	  ) AS viewer_vote_comment
//	FROM "profile_membership_referral" pmr
//	  INNER JOIN "profile_membership" ref_pm ON ref_pm.id = pmr.referrer_membership_id
//	  INNER JOIN "profile" ref_p ON ref_p.id = ref_pm.member_profile_id AND ref_p.deleted_at IS NULL
//	  INNER JOIN "profile_tx" ref_pt ON ref_pt.profile_id = ref_p.id
//	    AND ref_pt.locale_code = (
//	      SELECT rptf.locale_code FROM "profile_tx" rptf
//	      WHERE rptf.profile_id = ref_p.id
//	      ORDER BY CASE
//	        WHEN rptf.locale_code = $2 THEN 0
//	        WHEN rptf.locale_code = ref_p.default_locale THEN 1
//	        ELSE 2
//	      END
//	      LIMIT 1
//	    )
//	  INNER JOIN "profile" tgt_p ON tgt_p.id = pmr.referred_profile_id AND tgt_p.deleted_at IS NULL
//	  INNER JOIN "profile_tx" tgt_pt ON tgt_pt.profile_id = tgt_p.id
//	    AND tgt_pt.locale_code = (
//	      SELECT tptf.locale_code FROM "profile_tx" tptf
//	      WHERE tptf.profile_id = tgt_p.id
//	      ORDER BY CASE
//	        WHEN tptf.locale_code = $2 THEN 0
//	        WHEN tptf.locale_code = tgt_p.default_locale THEN 1
//	        ELSE 2
//	      END
//	      LIMIT 1
//	    )
//	WHERE pmr.profile_id = $3
//	  AND pmr.deleted_at IS NULL
//	ORDER BY pmr.created_at DESC
func (q *Queries) ListProfileMembershipReferralsByProfileID(ctx context.Context, arg ListProfileMembershipReferralsByProfileIDParams) ([]*ListProfileMembershipReferralsByProfileIDRow, error) {
	rows, err := q.db.QueryContext(ctx, listProfileMembershipReferralsByProfileID, arg.ViewerMembershipID, arg.LocaleCode, arg.ProfileID)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	items := []*ListProfileMembershipReferralsByProfileIDRow{}
	for rows.Next() {
		var i ListProfileMembershipReferralsByProfileIDRow
		if err := rows.Scan(
			&i.ID,
			&i.ProfileID,
			&i.ReferredProfileID,
			&i.ReferrerMembershipID,
			&i.Status,
			&i.VoteCount,
			&i.CreatedAt,
			&i.UpdatedAt,
			&i.DeletedAt,
			&i.ReferrerProfileSlug,
			&i.ReferrerProfileKind,
			&i.ReferrerProfilePictureURI,
			&i.ReferrerProfileTitle,
			&i.ReferredProfileSlug,
			&i.ReferredProfileKind,
			&i.ReferredProfilePictureURI,
			&i.ReferredProfileTitle,
			&i.TotalVotes,
			&i.AverageScore,
			&i.ViewerVoteScore,
			&i.ViewerVoteComment,
		); err != nil {
			return nil, err
		}
		items = append(items, &i)
	}
	if err := rows.Close(); err != nil {
		return nil, err
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const listReferralTeams = `-- name: ListReferralTeams :many
SELECT pt.id, pt.profile_id, pt.name, pt.description, pt.created_at, pt.deleted_at FROM "profile_team" pt
JOIN "profile_membership_referral_team" pmrt
  ON pmrt.profile_team_id = pt.id AND pmrt.deleted_at IS NULL
WHERE pmrt.profile_membership_referral_id = $1
  AND pt.deleted_at IS NULL
ORDER BY pt.name ASC
`

type ListReferralTeamsParams struct {
	ReferralID string `db:"referral_id" json:"referral_id"`
}

// ListReferralTeams
//
//	SELECT pt.id, pt.profile_id, pt.name, pt.description, pt.created_at, pt.deleted_at FROM "profile_team" pt
//	JOIN "profile_membership_referral_team" pmrt
//	  ON pmrt.profile_team_id = pt.id AND pmrt.deleted_at IS NULL
//	WHERE pmrt.profile_membership_referral_id = $1
//	  AND pt.deleted_at IS NULL
//	ORDER BY pt.name ASC
func (q *Queries) ListReferralTeams(ctx context.Context, arg ListReferralTeamsParams) ([]*ProfileTeam, error) {
	rows, err := q.db.QueryContext(ctx, listReferralTeams, arg.ReferralID)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	items := []*ProfileTeam{}
	for rows.Next() {
		var i ProfileTeam
		if err := rows.Scan(
			&i.ID,
			&i.ProfileID,
			&i.Name,
			&i.Description,
			&i.CreatedAt,
			&i.DeletedAt,
		); err != nil {
			return nil, err
		}
		items = append(items, &i)
	}
	if err := rows.Close(); err != nil {
		return nil, err
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const listReferralVotes = `-- name: ListReferralVotes :many
SELECT
  v.id, v.profile_membership_referral_id, v.voter_membership_id, v.score, v.comment, v.created_at, v.updated_at,
  vp.slug AS voter_profile_slug,
  vp.kind AS voter_profile_kind,
  vp.profile_picture_uri AS voter_profile_picture_uri,
  vpt.title AS voter_profile_title
FROM "profile_membership_referral_vote" v
  INNER JOIN "profile_membership" vm ON vm.id = v.voter_membership_id
  INNER JOIN "profile" vp ON vp.id = vm.member_profile_id AND vp.deleted_at IS NULL
  INNER JOIN "profile_tx" vpt ON vpt.profile_id = vp.id
    AND vpt.locale_code = (
      SELECT vptf.locale_code FROM "profile_tx" vptf
      WHERE vptf.profile_id = vp.id
      ORDER BY CASE
        WHEN vptf.locale_code = $1 THEN 0
        WHEN vptf.locale_code = vp.default_locale THEN 1
        ELSE 2
      END
      LIMIT 1
    )
WHERE v.profile_membership_referral_id = $2
ORDER BY v.created_at DESC
`

type ListReferralVotesParams struct {
	LocaleCode string `db:"locale_code" json:"locale_code"`
	ReferralID string `db:"referral_id" json:"referral_id"`
}

type ListReferralVotesRow struct {
	ID                          string         `db:"id" json:"id"`
	ProfileMembershipReferralID string         `db:"profile_membership_referral_id" json:"profile_membership_referral_id"`
	VoterMembershipID           string         `db:"voter_membership_id" json:"voter_membership_id"`
	Score                       int16          `db:"score" json:"score"`
	Comment                     sql.NullString `db:"comment" json:"comment"`
	CreatedAt                   time.Time      `db:"created_at" json:"created_at"`
	UpdatedAt                   sql.NullTime   `db:"updated_at" json:"updated_at"`
	VoterProfileSlug            string         `db:"voter_profile_slug" json:"voter_profile_slug"`
	VoterProfileKind            string         `db:"voter_profile_kind" json:"voter_profile_kind"`
	VoterProfilePictureURI      sql.NullString `db:"voter_profile_picture_uri" json:"voter_profile_picture_uri"`
	VoterProfileTitle           string         `db:"voter_profile_title" json:"voter_profile_title"`
}

// ListReferralVotes
//
//	SELECT
//	  v.id, v.profile_membership_referral_id, v.voter_membership_id, v.score, v.comment, v.created_at, v.updated_at,
//	  vp.slug AS voter_profile_slug,
//	  vp.kind AS voter_profile_kind,
//	  vp.profile_picture_uri AS voter_profile_picture_uri,
//	  vpt.title AS voter_profile_title
//	FROM "profile_membership_referral_vote" v
//	  INNER JOIN "profile_membership" vm ON vm.id = v.voter_membership_id
//	  INNER JOIN "profile" vp ON vp.id = vm.member_profile_id AND vp.deleted_at IS NULL
//	  INNER JOIN "profile_tx" vpt ON vpt.profile_id = vp.id
//	    AND vpt.locale_code = (
//	      SELECT vptf.locale_code FROM "profile_tx" vptf
//	      WHERE vptf.profile_id = vp.id
//	      ORDER BY CASE
//	        WHEN vptf.locale_code = $1 THEN 0
//	        WHEN vptf.locale_code = vp.default_locale THEN 1
//	        ELSE 2
//	      END
//	      LIMIT 1
//	    )
//	WHERE v.profile_membership_referral_id = $2
//	ORDER BY v.created_at DESC
func (q *Queries) ListReferralVotes(ctx context.Context, arg ListReferralVotesParams) ([]*ListReferralVotesRow, error) {
	rows, err := q.db.QueryContext(ctx, listReferralVotes, arg.LocaleCode, arg.ReferralID)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	items := []*ListReferralVotesRow{}
	for rows.Next() {
		var i ListReferralVotesRow
		if err := rows.Scan(
			&i.ID,
			&i.ProfileMembershipReferralID,
			&i.VoterMembershipID,
			&i.Score,
			&i.Comment,
			&i.CreatedAt,
			&i.UpdatedAt,
			&i.VoterProfileSlug,
			&i.VoterProfileKind,
			&i.VoterProfilePictureURI,
			&i.VoterProfileTitle,
		); err != nil {
			return nil, err
		}
		items = append(items, &i)
	}
	if err := rows.Close(); err != nil {
		return nil, err
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const softDeleteReferral = `-- name: SoftDeleteReferral :execrows
UPDATE "profile_membership_referral"
SET deleted_at = NOW()
WHERE id = $1 AND deleted_at IS NULL
`

type SoftDeleteReferralParams struct {
	ID string `db:"id" json:"id"`
}

// SoftDeleteReferral
//
//	UPDATE "profile_membership_referral"
//	SET deleted_at = NOW()
//	WHERE id = $1 AND deleted_at IS NULL
func (q *Queries) SoftDeleteReferral(ctx context.Context, arg SoftDeleteReferralParams) (int64, error) {
	result, err := q.db.ExecContext(ctx, softDeleteReferral, arg.ID)
	if err != nil {
		return 0, err
	}
	return result.RowsAffected()
}

const updateReferralVoteCount = `-- name: UpdateReferralVoteCount :exec
UPDATE "profile_membership_referral"
SET vote_count = (
  SELECT COUNT(*) FROM "profile_membership_referral_vote"
  WHERE profile_membership_referral_id = $1
), updated_at = NOW()
WHERE id = $1 AND deleted_at IS NULL
`

type UpdateReferralVoteCountParams struct {
	ID string `db:"id" json:"id"`
}

// UpdateReferralVoteCount
//
//	UPDATE "profile_membership_referral"
//	SET vote_count = (
//	  SELECT COUNT(*) FROM "profile_membership_referral_vote"
//	  WHERE profile_membership_referral_id = $1
//	), updated_at = NOW()
//	WHERE id = $1 AND deleted_at IS NULL
func (q *Queries) UpdateReferralVoteCount(ctx context.Context, arg UpdateReferralVoteCountParams) error {
	_, err := q.db.ExecContext(ctx, updateReferralVoteCount, arg.ID)
	return err
}

const upsertReferralVote = `-- name: UpsertReferralVote :one
INSERT INTO "profile_membership_referral_vote" (
  id, profile_membership_referral_id, voter_membership_id, score, comment, created_at
) VALUES (
  $1,
  $2,
  $3,
  $4,
  $5,
  NOW()
) ON CONFLICT (profile_membership_referral_id, voter_membership_id)
DO UPDATE SET
  score = EXCLUDED.score,
  comment = EXCLUDED.comment,
  updated_at = NOW()
RETURNING id, profile_membership_referral_id, voter_membership_id, score, comment, created_at, updated_at
`

type UpsertReferralVoteParams struct {
	ID                          string         `db:"id" json:"id"`
	ProfileMembershipReferralID string         `db:"profile_membership_referral_id" json:"profile_membership_referral_id"`
	VoterMembershipID           string         `db:"voter_membership_id" json:"voter_membership_id"`
	Score                       int16          `db:"score" json:"score"`
	Comment                     sql.NullString `db:"comment" json:"comment"`
}

// UpsertReferralVote
//
//	INSERT INTO "profile_membership_referral_vote" (
//	  id, profile_membership_referral_id, voter_membership_id, score, comment, created_at
//	) VALUES (
//	  $1,
//	  $2,
//	  $3,
//	  $4,
//	  $5,
//	  NOW()
//	) ON CONFLICT (profile_membership_referral_id, voter_membership_id)
//	DO UPDATE SET
//	  score = EXCLUDED.score,
//	  comment = EXCLUDED.comment,
//	  updated_at = NOW()
//	RETURNING id, profile_membership_referral_id, voter_membership_id, score, comment, created_at, updated_at
func (q *Queries) UpsertReferralVote(ctx context.Context, arg UpsertReferralVoteParams) (*ProfileMembershipReferralVote, error) {
	row := q.db.QueryRowContext(ctx, upsertReferralVote,
		arg.ID,
		arg.ProfileMembershipReferralID,
		arg.VoterMembershipID,
		arg.Score,
		arg.Comment,
	)
	var i ProfileMembershipReferralVote
	err := row.Scan(
		&i.ID,
		&i.ProfileMembershipReferralID,
		&i.VoterMembershipID,
		&i.Score,
		&i.Comment,
		&i.CreatedAt,
		&i.UpdatedAt,
	)
	return &i, err
}
